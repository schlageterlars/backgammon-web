@(implicit request: play.api.mvc.RequestHeader)
@import helper.CSRF

@main("Lobby") {  
</div>
  <main class="container py-5">

    <div class="text-center my-4">

  <div class="content">
		<h2>BACKGAMMON</h2>
	</div>

<div class="fishing-container">
  <div class="rod">
    <div class="line">
      <div class="fish">

<svg viewBox="0 0 64 32" width="168" height="10 4" xmlns="http://www.w3.org/2000/svg">
  <!-- bottom page -->
  <polygon points="6,8 58,8 56,26 8,26" fill="#D2B48C" stroke="#A0522D" stroke-width="0.5"/>

  <!-- top page slightly curled -->
  <path d="M6,8 Q7,6 58,8 Q59,10 60,10 L56,26 Q55,28 8,26 Q7,24 6,8 Z" fill="#F5DEB3" stroke="#A0522D" stroke-width="0.5"/>

  <!-- fold lines for texture -->
  <line x1="10" y1="10" x2="54" y2="11" stroke="#C8A165" stroke-width="0.3"/>
  <line x1="12" y1="14" x2="56" y2="15" stroke="#C8A165" stroke-width="0.3"/>
  <line x1="8" y1="18" x2="50" y2="19" stroke="#C8A165" stroke-width="0.3"/>
  <line x1="14" y1="22" x2="54" y2="23" stroke="#C8A165" stroke-width="0.3"/>

  <!-- small creases / worn edges -->
  <line x1="7" y1="9" x2="8" y2="11" stroke="#C8A165" stroke-width="0.2"/>
  <line x1="57" y1="9" x2="58" y2="11" stroke="#C8A165" stroke-width="0.2"/>
  <line x1="10" y1="25" x2="12" y2="26" stroke="#C8A165" stroke-width="0.2"/>
  <line x1="52" y1="24" x2="54" y2="25" stroke="#C8A165" stroke-width="0.2"/>

  <!-- centered label -->
  <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#5A2E0B" font-size="6" font-family="Orbitron" font-weight="bold">Rules</text>
</svg>
      </div>
    </div>
  </div>
</div>
<style>

/* Rod */
.rod {
  position: absolute;
  top: 0;
  left: 10%;
  width: 6px;
  height: 100px;
  background: #654321; /* brown rod */
  transform-origin: top center;
  animation: swing 2s ease-in-out infinite alternate;
}

/* Line */
.line {
  position: absolute;
  top: 100px; /* rod height */
  left: 10%;
  width: 2px;
  height: 100px; /* length of line */
  background: #222;
  transform: translateX(-10%);
  transform-origin: top center;
}

.fish {
  position: absolute;
  cursor: pointer;
  top: 200%;
  transform: translateX(-50%) rotate(-90deg); /* Mund zur Schnur */
  transform-origin: top left; /* Drehpunkt oben (Mund hängt an der Schnur) */
  animation: bob 2s ease-in-out infinite alternate;
}

/* Optional: leichtes Pendeln beim Schwingen */
@@keyframes bob {
  0% { transform: translateX(-50%) rotate(-70deg) translateY(0); }
  25% { transform: translateX(-40%) rotate(-80deg) translateY(2px); }
  50% { transform: translateX(-25%) rotate(-90deg) translateY(6px); }
  75% { transform: translateX(-15%) rotate(-100deg) translateY(6px); }
  100% { transform: translateX(-20%) rotate(-90deg) translateY(0); }
}
/* Rod swing animation */
@@keyframes swing {
  0% { transform: rotate(-10deg); }
  50% { transform: rotate(10deg); }
  100% { transform: rotate(-10deg); }
}
</style>
</div>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="@routes.Assets.versioned("stylesheets/weltall.css")">

<div class="row justify-content-center mb-4">
  <div class="col-12 col-md-10 col-lg-8">
    <input type="text" id="playerName" name="playerName" class="form-control" 
           placeholder="Enter your name" required 
           value="@request.session.get("username").getOrElse("")">
  </div>
</div>

<script>
$(function() {
  function updateLobbyButton() {
    if ($('#scopePublic').is(':checked')) {
      // Public selected → show count and Quick Join
      $('#openLobbyCount').show();
      $('#createLobby').text('Quick Join');

      // Optional: dynamically update count
      // $('#openLobbyCount').text('5 open lobbies');
    } else {
      // Private selected → hide count and change button
      $('#openLobbyCount').hide();
      $('#createLobby').text('Create Lobby');
    }
  }

  // Run on page load
  updateLobbyButton();

  // Listen for changes
  $('input[name="scope"]').on('change', updateLobbyButton);
});

$(document).ready(function() {
  const csrfToken = '@CSRF.getToken.value';

  $('#playerName').on('change', function() {
    $.post({
      url: '/update-username',
      data: { username: $(this).val() },
      headers: { 'Csrf-Token': csrfToken },
      success: function() { console.log('Username saved to session'); },
      error: function() { console.error('Failed to save username'); }
    });
  });

      document.getElementById("createLobby").addEventListener("click", async () => {
      const csrfToken = '@CSRF.getToken.value';

      const username = document.getElementById("playerName").value;
      if (!username) return alert("Enter a username");

      // Get selected board size
      const boardSizeInput = document.querySelector('input[name="boardSize"]:checked');
      const boardSize = boardSizeInput ? boardSizeInput.value : null;

      // Get selected scope
      const scopeInput = document.querySelector('input[name="scope"]:checked');
      const scope = scopeInput ? scopeInput.value : null;

      // Get selected scope
      const playerInput = document.querySelector('input[name="playerColor"]:checked');
      const player = playerInput ? playerInput.value : null;


      const response = await fetch("/lobby", {
        method: "POST",
        headers: { 
          "Content-Type": "application/x-www-form-urlencoded",
          "Csrf-Token": csrfToken
        },
        body: new URLSearchParams({             
          scope, 
          boardSize,
          player
        })
      });

      if (response.redirected) {
        window.location.href = response.url + "?state=created";; // Redirect to /lobby/lobbyId
      } else {
        const data = await response.text();
        showToast(data, "danger");
      }
    });
});
</script>

<div class="row justify-content-center g-4 mt-4">

  <!-- Start a new game (2/3 width on large screens) -->
  <div class="col-12 col-lg-8">
    <div class="card card-lobby p-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
          <h3 class="mb-0">Start a new game</h3>
          <div class="muted-sm">Prepare your game and invite friends — or go public and match with players.</div>
        </div>
        <div class="text-end">
          <small class="text-muted">Preview</small>
          <div id="previewBadge" class="d-inline-block ms-2 badge bg-light text-dark">
            Classic • Public
          </div>
        </div>
      </div>

      <form id="lobbyForm" class="row g-3">

        <!-- Board size -->
        <div class="col-12">
          <label class="form-label fw-semibold">Board size</label>

          <div class="row row-cols-1 row-cols-sm-3 g-3">

            <div class="col">
              <input type="radio" class="btn-check" name="boardSize" id="sizeSmall" value="Small" autocomplete="off">
              <label class="option-card card p-3 text-center h-100 d-block" for="sizeSmall" style="cursor: pointer;">
                <div class="mb-2"><i class="bi bi-arrows-angle-contract fs-2"></i></div>
                <div class="fw-bold">Small</div>
                <div class="muted-sm">Quick rounds, great for beginners</div>
              </label>
            </div>

            <div class="col">
              <input type="radio" class="btn-check" name="boardSize" id="sizeMedium" value="Medium" autocomplete="off">
              <label class="option-card card p-3 text-center h-100 d-block" for="sizeMedium" style="cursor: pointer;">
                <div class="mb-2"><i class="bi bi-grid-3x3-gap fs-2"></i></div>
                <div class="fw-bold">Medium</div>
                <div class="muted-sm">Balanced playtime and strategy</div>
              </label>
            </div>

            <div class="col">
              <input type="radio" class="btn-check" name="boardSize" id="sizeClassic" value="Classic" autocomplete="off" checked>
              <label class="option-card card p-3 text-center h-100 d-block" for="sizeClassic" style="cursor: pointer;">
                <div class="mb-2"><i class="bi bi-grid fs-2"></i></div>
                <div class="fw-bold">Classic</div>
                <div class="muted-sm">The original and most balanced board</div>
              </label>
            </div>

          </div>
        </div>

        <!-- Your play as -->
        <div class="col-12">
          <label class="form-label fw-semibold">Your play as</label>

          <div class="row row-cols-3 g-3">

            <!-- White -->
            <div class="col">
              <input type="radio" class="btn-check" name="playerColor" id="colorWhite" value="White" autocomplete="off" checked>
              <label class="option-card card p-3 text-center h-100 d-flex align-items-center justify-content-center" 
                    for="colorWhite" style="cursor: pointer;">
                <div class="checker-icon checker-white"></div>
              </label>
            </div>

            <!-- Black -->
            <div class="col">
              <input type="radio" class="btn-check" name="playerColor" id="colorBlack" value="Black" autocomplete="off">
              <label class="option-card card p-3 text-center h-100 d-flex align-items-center justify-content-center" 
                    for="colorBlack" style="cursor: pointer;">
                <div class="checker-icon checker-black"></div>
              </label>
            </div>

            <!-- Random -->
            <div class="col">
              <input type="radio" class="btn-check" name="playerColor" id="colorRandom" value="Random" autocomplete="off">
              <label class="option-card card p-3 text-center h-100 d-flex align-items-center justify-content-center" 
                    for="colorRandom" style="cursor: pointer;">
                <div class="checker-icon checker-random"></div>
              </label>
            </div>

          </div>
        </div>


        <!-- Scope -->
        <div class="col-12">
          <label class="form-label fw-semibold">Scope</label>

          <div class="d-flex gap-3">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="scope" id="scopePublic" value="Public" checked>
              <label class="form-check-label" for="scopePublic" style="cursor: pointer;">
                Public <small class="text-muted">(match with players)</small>
              </label>
            </div>

            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="scope" id="scopePrivate" value="Private">
              <label class="form-check-label" for="scopePrivate" style="cursor: pointer;">
                Private <span class="badge badge-private ms-2">Play with friend</span>
              </label>
            </div>
          </div>

        </div>


        <!-- Create Button -->
        <div class="col-12 d-flex justify-content-end align-items-center gap-2">
          <span id="openLobbyCount" class="text-muted small me-4">0 open lobbies</span>

          <button id="createLobby" type="button" class="btn btn-primary">
            Quick Join
          </button>
        </div>

      </form>
    </div>
  </div>

  <!-- Join Lobby (1/3 width on large screens) -->
  <div class="col-12 col-lg-4">
    <div class="card card-lobby p-4">

      <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
          <h3 class="mb-0">Join a lobby</h3>
          <div class="muted-sm">Enter a friend’s invite code to join their private game.</div>
        </div>
      </div>

      <div class="row g-3">

        <!-- Lobby Code Input -->
        <div class="col-12">
          <label class="form-label fw-semibold" for="joinCode">Lobby Code</label>
          <input type="text" id="joinCode" class="form-control" placeholder="Enter lobby code...">
        </div>

        <!-- Join Button -->
        <div class="col-12 d-flex justify-content-end">
          <button id="joinLobby" type="button" class="btn btn-outline-primary">
            Start Match
          </button>
        </div>

      </div>

    </div>
  </div>

</div>
</main>

<div class="wave wave-1"></div>
<div class="wave wave-2"></div>
<div class="wave wave-3"></div>


}
