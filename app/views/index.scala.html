<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vue SPA + Play</title>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@@3/dist/vue.global.js"></script>
    <!-- Vue Router -->
    <script src="https://unpkg.com/vue-router@@4"></script>
  </head>

  <body>
    <div id="app">
      <h2>Vue SPA</h2>

      <nav>
        <a href="#/">Home</a> |
        <a href="#/create">Create Lobby</a> |
        <a href="#/lobby/123">Lobby 123</a>
      </nav>

      <hr>

      <!-- where the SPA renders -->
      <router-view></router-view>
    </div>

    <script type="module">
      const { createApp } = Vue
      const { createRouter, createWebHashHistory } = VueRouter

      // -------------------------
      // Views
      // -------------------------

      const CreateLobby = {
        data() {
          return {
            scope: "public",
            boardSize: "6",
            player: "p1",
            csrfToken: ""
          }
        },
        async created() {
          // Example: extract CSRF token if Play sends it
          this.csrfToken = document.querySelector('meta[name="csrf-token"]')?.content ?? ""
        },
        methods: {
          async createLobby() {
            const response = await fetch("/lobby", {
              method: "POST",
              headers: { 
                "Content-Type": "application/x-www-form-urlencoded",
                "Csrf-Token": this.csrfToken
              },
              body: new URLSearchParams({
                scope: this.scope,
                boardSize: this.boardSize,
                player: this.player
              })
            })

            if (response.redirected) {
              // backend gives /lobby/:id
              const url = new URL(response.url)
              const lobbyId = url.pathname.split("/").pop()
              this.$router.push(`/lobby/${lobbyId}`)
            } else {
              alert(await response.text())
            }
          }
        },
        template: `
          <div>
            <h3>Create Lobby</h3>
            <button @@click="createLobby">Create</button>
          </div>
        `
      }

      const Lobby = {
        template: `<h3>Lobby ID: {{ $route.params.lobbyId }}</h3>`
      }

      import Home from '/Home.vue';


      // -------------------------
      // Router
      // -------------------------
      const router = createRouter({
        history: createWebHashHistory(),
        routes: [
          { path: "/", component: Home },
          { path: "/create", component: CreateLobby },
          { path: "/lobby/:lobbyId", component: Lobby }
        ]
      })

      // -------------------------
      // Vue App
      // -------------------------
      createApp({}).use(router).mount("#app")
    </script>
  </body>
</html>
